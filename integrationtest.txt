# Navigate to your project
cd ~/kanban_system
source venv/bin/activate

# Create integration test directory if it doesn't exist
mkdir -p tests/integration
touch tests/integration/__init__.py

cat > tests/conftest.py << 'EOF'
import pytest
import sqlite3
import tempfile
import os
import sys
from pathlib import Path
from datetime import datetime, timedelta
import bcrypt

# Add project root to Python path
sys.path.insert(0, os.path.abspath('.'))

@pytest.fixture
def temp_db():
    """Create a temporary SQLite database for integration testing."""
    with tempfile.NamedTemporaryFile(suffix='.db', delete=False) as f:
        db_path = f.name
    
    # Create the database file
    conn = sqlite3.connect(db_path)
    conn.close()
    
    yield db_path
    
    # Cleanup
    if os.path.exists(db_path):
        os.unlink(db_path)

@pytest.fixture
def setup_database_schema(temp_db):
    """Set up the complete database schema for integration tests."""
    # Import Database and KanbanInfoDatabase modules
    import Database
    import KanbanInfoDatabase as kdb
    
    # Set the database path for both modules
    original_db_path = Database.DB_PATH
    original_kdb_path = kdb.DB_PATH
    
    Database.DB_PATH = temp_db
    kdb.DB_PATH = temp_db
    
    # Initialize both databases
    Database.InitDB()
    kdb.InitDB()
    
    yield temp_db, Database, kdb
    
    # Restore original paths
    Database.DB_PATH = original_db_path
    kdb.DB_PATH = original_kdb_path

@pytest.fixture
def sample_test_data(setup_database_schema):
    """Create sample test data in the database."""
    temp_db, Database, kdb = setup_database_schema
    
    # Create test users
    test_users = [
        (1234567890, "Admin User", "Admin", "adminpass123", 1),  # Active admin
        (9876543210, "Regular User", "User", "userpass123", 1),  # Active user
        (5555555555, "Inactive User", "User", "inactivepass", 0),  # Inactive user
        (1111111111, "Manager User", "Manager", "managerpass", 1),  # Another active user
    ]
    
    for phone, name, position, password, active in test_users:
        try:
            Database.CreateUser(phone, name, position, password)
            if active == 0:
                Database.ChangeActivationStatus(phone, 0)
        except ValueError:
            pass  # User might already exist
    
    return temp_db, Database, kdb

@pytest.fixture
def sample_tasks(sample_test_data):
    """Create sample tasks in the database."""
    temp_db, Database, kdb = sample_test_data
    
    # Add some test tasks
    test_tasks = [
        ("Task 1: Planning", "To-Do", 9876543210, "2024-12-31", 1234567890, "Initial planning phase"),
        ("Task 2: Development", "In Progress", 9876543210, "2024-12-25", 1234567890, "Core development"),
        ("Task 3: Review", "Waiting Review", 1111111111, "2024-12-20", 1234567890, "Code review"),
        ("Task 4: Completed", "Finished", 1111111111, "2024-12-15", 9876543210, "Already completed"),
    ]
    
    for title, status, person, due, creator, info in test_tasks:
        kdb.AddTask(
            title, status, person, 
            datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            due, creator, info
        )
    
    return temp_db, Database, kdb
EOF


#Create tests/integration/test_database_operations.py
cat > tests/integration/test_database_operations.py << 'EOF'
"""
Integration tests for Database.py with SQLite
Tests: User table creation, user CRUD operations, password hashing, activation status
"""
import pytest
import sys
import os
import bcrypt

sys.path.insert(0, os.path.abspath('.'))

class TestDatabaseOperationsIntegration:
    """Integration tests for Database.py with actual SQLite database."""
    
    
    def test_user_creation_with_phone_uniqueness(self, setup_database_schema):
        """Test user creation and phone number uniqueness constraint."""
        temp_db, Database, kdb = setup_database_schema
        
        # Create first user - should succeed
        Database.CreateUser(
            PhoneNo=1234567890,
            Name="Test User",
            Position="User",
            Password="testpassword123"
        )
        
        # Verify user was created
        user = Database.GetUserByPhone(1234567890)
        assert user is not None
        assert user["Name"] == "Test User"
        assert user["Position"] == "User"
        assert user["Activation status"] == 0  # User should be inactive by default
        
        # Try to create user with same phone number - should raise ValueError
        with pytest.raises(ValueError, match="Phone number already exists"):
            Database.CreateUser(
                PhoneNo=1234567890,
                Name="Duplicate User",
                Position="User",
                Password="anotherpass"
            )
    
    def test_admin_creation_active_by_default(self, setup_database_schema):
        """Test that admin users are created as active by default."""
        temp_db, Database, kdb = setup_database_schema
        
        # Create admin user
        Database.CreateUser(
            PhoneNo=9999999999,
            Name="Admin User",
            Position="Admin",
            Password="adminpass"
        )
        
        # Admin should be active by default
        admin_user = Database.GetUserByPhone(9999999999)
        assert admin_user["Activation status"] == 1
        
        # Admin should be able to login immediately
        login_result = Database.ValidateLogin(9999999999, "adminpass")
        assert login_result is not None
        assert login_result["Position"] == "Admin"
    
    def test_user_data_persistence(self, temp_db):
        """Test that user data persists across database connections."""
        import Database
        
        original_path = Database.DB_PATH
        Database.DB_PATH = temp_db
        
        try:
            # Initialize and create user
            Database.InitDB()
            Database.CreateUser(1231231234, "Persistent User", "User", "persistpass")
            Database.ChangeActivationStatus(1231231234, 1)
            
            # Close connection (simulated by re-importing)
            # Actually, each function opens/closes its own connection
            
            # Re-query user
            user = Database.GetUserByPhone(1231231234)
            assert user is not None
            assert user["Name"] == "Persistent User"
            
            # Update user activation
            Database.ChangeActivationStatus(1231231234, 0)
            
            # Verify update persisted
            updated_user = Database.GetUserByPhone(1231231234)
            assert updated_user["Activation status"] == 0
            
        finally:
            Database.DB_PATH = original_path
    
    def test_multiple_user_operations(self, setup_database_schema):
        """Test operations with multiple users."""
        temp_db, Database, kdb = setup_database_schema
        
        # Create multiple users
        users = [
            (1111111111, "User One", "User", "pass1"),
            (2222222222, "User Two", "User", "pass2"),
            (3333333333, "User Three", "Manager", "pass3"),
        ]
        
        for phone, name, position, password in users:
            Database.CreateUser(phone, name, position, password)
            Database.ChangeActivationStatus(phone, 1)
        
        # Verify all users exist
        for phone, name, position, password in users:
            user = Database.GetUserByPhone(phone)
            assert user is not None
            assert user["Name"] == name
            assert user["Position"] == position
            
            # Should be able to login
            login_result = Database.ValidateLogin(phone, password)
            assert login_result is not None
            assert login_result["Phone number"] == phone
        
        # Test getting non-existent user
        non_existent = Database.GetUserByPhone(9999999999)
        assert non_existent is None

# Need to import sqlite3 for table inspection
import sqlite3
EOF

pytest tests/integration/test_database_operations.py -v
